language: rust
env:
  - RUSTFLAGS='-F warnings'
rust:
  - stable
#  - nightly
#  - beta
os:
  - linux
#  - osx
  - windows
services:
  - docker
before_script:
  - rustup component add rustfmt
  - rustup component add clippy
script:
  - cargo build --verbose  --all
stages:
  - Check
  - Test
cache: cargo
matrix:
  allow_failures:
    - rust: nightly
  fast_finish: true
  include:
    - stage: Check
      name: Format
      script:
        - cargo fmt --all -- --check
    - stage: Check
      name: Clippy
      script:
        -  RUSTFLAGS='-F warnings' cargo clippy --all
    - stage: Test
      name: unit test and bench test(exclude mplex)
      os: linux
      script:
        - cargo test --all --exclude mplex --exclude yamux
        - cargo bench --all --exclude mplex --exclude yamux
    - stage: Test
      name: Secio simple that rust client connect  go server
      #rust: nightly
      os: linux
      script:
        - cd protocols/secio/examples/go && docker build -t libp2p-rs/go-secio-server:latest  .
        - cd ../../../../
        #- echo "$DOCKER_PASSWORD" | docker login --username "$DOCKER_USERNAME" --password-stdin registry.paradeum.com
        #- docker tag libp2p-rs/go-secio-server:latest registry.paradeum.com/libp2p-rs/go-secio-server:latest 
        #- docker push registry.paradeum.com/libp2p-rs/go-secio-server:latest
        - docker run -d  -p 1337:1337 libp2p-rs/go-secio-server:latest
        - docker ps -a
        - pwd
        - RUST_LOG=debug cargo run --example secio_simple

branches:
  only: master

notifications:
  webhooks: https://oapi.dingtalk.com/robot/send?access_token=fc99eb4ea3aa6b97692e253f86beb564af92c70fbf51df833739503eab4eaee0